local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local Player = Players.LocalPlayer

-- T·∫°o GUI
local screenGui = Instance.new("ScreenGui")
screenGui.Name = "AbilityESP_GUI"
screenGui.Parent = game:GetService("CoreGui")

local toggleButton = Instance.new("TextButton")
toggleButton.Size = UDim2.new(0, 120, 0, 40)
toggleButton.Position = UDim2.new(0, 20, 0, 100)
toggleButton.BackgroundColor3 = Color3.fromRGB(50, 50, 50)
toggleButton.TextColor3 = Color3.new(1, 1, 1)
toggleButton.Font = Enum.Font.GothamBold
toggleButton.TextSize = 14
toggleButton.Text = "ESP: OFF"
toggleButton.Parent = screenGui

-- Bi·∫øn
local enabled = false
local billboardLabels = {}
local connection

-- T·∫°o label tr√™n ƒë·∫ßu player kh√°c
local function createBillboard(p)
	local character = p.Character
	while not character or not character.Parent do
		task.wait()
		character = p.Character
	end

	local head = character:WaitForChild("Head")
	if billboardLabels[p] then
		billboardLabels[p].gui:Destroy()
	end

	local billboard = Instance.new("BillboardGui")
	billboard.Name = "AbilityESP"
	billboard.Adornee = head
	billboard.Size = UDim2.new(0, 200, 0, 25)
	billboard.StudsOffset = Vector3.new(0, 3.5, 0)
	billboard.AlwaysOnTop = true
	billboard.Parent = head

	local label = Instance.new("TextLabel")
	label.Size = UDim2.new(1, 0, 1, 0)
	label.BackgroundTransparency = 1
	label.Font = Enum.Font.GothamBold
	label.TextColor3 = Color3.fromRGB(255, 255, 255)
	label.TextStrokeTransparency = 0.6
	label.TextSize = 14
	label.TextWrapped = true
	label.TextXAlignment = Enum.TextXAlignment.Center
	label.TextYAlignment = Enum.TextYAlignment.Center
	label.Text = ""
	label.Visible = false
	label.Parent = billboard

	billboardLabels[p] = {
		gui = billboard,
		label = label
	}

	local humanoid = character:FindFirstChild("Humanoid")
	if humanoid then
		humanoid.Died:Connect(function()
			if billboard then billboard:Destroy() end
			billboardLabels[p] = nil
		end)
	end
end

-- Setup cho ng∆∞·ªùi ch∆°i hi·ªán c√≥
for _, p in ipairs(Players:GetPlayers()) do
	if p ~= Player then
		p.CharacterAdded:Connect(function()
			createBillboard(p)
		end)
		if p.Character then
			createBillboard(p)
		end
	end
end

-- Ng∆∞·ªùi ch∆°i m·ªõi
Players.PlayerAdded:Connect(function(p)
	if p ~= Player then
		p.CharacterAdded:Connect(function()
			createBillboard(p)
		end)
	end
end)

-- Update label m·ªói frame
local function updateESP(state)
	if state then
		connection = RunService.Heartbeat:Connect(function()
			for p, data in pairs(billboardLabels) do
				if p.Character and p.Character:FindFirstChild("Head") then
					local ability = p:GetAttribute("EquippedAbility")
					data.label.Text = ability and (p.DisplayName .. " [" .. ability .. "]") or p.DisplayName
					data.label.Visible = true
				else
					data.label.Visible = false
				end
			end
		end)
	else
		if connection then
			connection:Disconnect()
			connection = nil
		end
		for _, data in pairs(billboardLabels) do
			data.label.Visible = false
			data.label.Text = ""
		end
	end
end

-- Toggle n√∫t
toggleButton.MouseButton1Click:Connect(function()
	enabled = not enabled
	toggleButton.Text = "ESP: " .. (enabled and "ON" or "OFF")
	updateESP(enabled)
end)

-- üß® ƒê√¢y l√† h√†m b·∫°n g·ªçi ƒë·ªÉ "x√≥a n√∫t v√† d·ª´ng ESP"
function offbutton()
	if connection then
		connection:Disconnect()
		connection = nil
	end
	for _, data in pairs(billboardLabels) do
		data.label.Visible = false
		data.label.Text = ""
	end
	if screenGui then
		screenGui:Destroy()
	end
end

-- ‚úÖ G√°n v√†o _G ƒë·ªÉ g·ªçi t·ª´ script kh√°c
_G.offbutton = offbutton
